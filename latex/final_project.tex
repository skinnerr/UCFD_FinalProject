\documentclass[11pt]{article}

\input{./preamble.tex}

%%
%% DOCUMENT START
%%

\begin{document}
\fancypagestyle{allpages}
{
	\fancyhf[LH]{\rightmark}
	\fancyhf[CH]{}
	\fancyhf[RH]{\thepage\hspace*{1ex}/\hspace*{1ex}\pageref{lastpage}}
	\fancyhf[LF]{}
	\fancyhf[CF]{}
	\fancyhf[RF]{}
}

\fancypagestyle{firstpage}
{
	\fancyhf[LH]{\Large Final Project \\ \large ASEN 5519: Unstructured CFD}
	\fancyhf[CH]{}
	\fancyhf[RH]{\large Ryan Skinner \\ \large Due 2016/??/??}
	\fancyhf[LF]{}
	\fancyhf[CF]{}
	\fancyhf[RF]{}
}

\pagestyle{allpages}
\thispagestyle{firstpage}
\renewcommand{\sectionmark}[1]{ \markright{#1}{} }

\vspace*{0in}
\begin{center}
\LARGE Improving Boundary Condition Stability in PHASTA
\end{center}
\vspace*{0.3in}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Initial Outline of PHASTA}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

PHASTA begins execution at |main|, located in |phSolver/[in]compressible|, depending on which branch is desired. This function initializes MPI, and then calls |phasta|, located in |/phSolver/common|. Here, inputs are read and computed in |input|, and then the solver is run by calling |proces|, a Fortran routine. Within |proces|, |gendat| generates geometry and BC data.

Routines followed by an asterisk (\ra) are outlined in further detail separately.

{\huge \color{red!75!black} INCOMPRESSIBLE ONLY}, and we ignore cardiovascular impedance and RCR boundary stuff.

\begin{outline}[deep]
\1 |main|
	\2 initialize MPI
	\2 |phasta|
		\3 initialize PETSc
		\3 set input data paths
		\3 |input| --- populate data structures with problem set-up and solver parameters
			\4 |readnblk| --- read and blocks data
				\5 read |numstart.dat| and finds appropriate |restart.dat| files
				\5 read geometry from Posix or SyncIO files using |phio_readheader|
				\5 calculate maximum number of boundary element nodes
				\5 initialize constants like |ndof|, |ndofBC|, |ndiBCB|, and |ndBCB|
				\5 |genblk| --- read and block connectivity
				\5 read BC mapping array into |nBC|
				\5 read temporary boundary condition code into |iBCtmp|
				\5 read BC data into |BCinp|
				\5 read periodic BC data into |iperread|
				\5 |genbkb| --- generate boundary element blocks and traces for gather/scatter operations
				\5 read restart data into diffusive flux vector |qold|, primitive variables |uold|, and accelerations |acold|
			\4 echo global information
			\4 assert valid input constants (e.g. |icoord|, |navier|, |iexec|) defined in |common.h|
			\4 echo solver and integration information
			\4 |genint| --- generate integration information
			\4 estimate number of nonzero globals
			\4 compute fluid thermodynamic properties
		\3 |proces| --- generate problem data and calls the solution driver
			\4 |gendat| --- generate geometry and BC data
				\5 |getshp| --- generate the interior nodal mapping
				\5 |geniBC| --- generate boundary condition codes
				\5 |genBC| --- generate the essential boundary conditions
				\5 work with Dirichlet-to-Neumann BCs (?)
				\5 |genshpb| --- generate boundary element shape functions
				\5 |genini| --- read initial values in primitive ($\ul{U}$) form, satisfies BCs, and converts to $\ul{Y}$ form, filling the |y| vector
			\4 |setper| and |perprep| --- store inverse of sum of one and number of slaves in |rcount|
			\4 LES-specific routines |keeplhsG| and |setrls| called as needed
			\4 |initStats| --- allocate arrays to store flow statistics
			\4 RANS-specific routine |initTurb|
			\4 cardiovascular-specific routine |initSponge|
			\4 adjust BCs to interpolate from file |inlet.dat|, if it exists
			\4 set up eddy-viscosity ramp specific to NGC/Duct case
			\4 |itrdrv|\ra --- iterate the discrete solution using the predictor multi-corrector algorithm
		\3 finalize PETSc
	\2 finalize MPI
\end{outline}

Numerical solution of the time-integrated unsteady Navier-Stokes equations occurs within |itrdrv|. Working arrays are listed in Table \ref{tbl:symbols}.
\begin{outline}[deep]
\1 |itrdrv|
	\2 |initTimeSeries| --- initialize time series collection to |varts.*.dat| files using |xyzts.dat| input
	\2 initialize |istep| and |ifuncs(:)| to zero, and set |yold = y| and |acold = ac|
	\2 |initEQS| --- initialize equation solver (look into this later \ra ?)
	\2 |do itsq = 1, ntseq| --- main loop over time sequences
		\3 set |itseq = itsq|
		\3 set iteration-specific variables for |nstep|, |niter|, |loctim|, and |deltol|
		\3 |itrsetup| --- set up time integration parameters
			\4 calculate $\alpha_m$, $\alpha_f$, and $\gamma$ as functions of $\rho_\infty$
%			\4 set Jacobian type (appears to be for a fringe case only?)
%			\4 mess with |ipred| and |y| for the same-delta predictor if we're on the first sequence
			\4 set global time increment inverse |Dtgl| and CFL data |CFLfl|
		\3 calculate number of flow solves per step, store in |nitr|
		\3 |do istp = 1, nstp| --- main loop over time steps
			\4 |asbwmod| --- set traction BCs if turbulence wall model is set (|itwmod|)
			\4 |itrPredict|\ra --- predict primitive variables at time $n+1$
			\4 |itrBC|\ra --- satisfy BCs on the primitive variables; returns a modified |y|
			\4 |itrBCSclr|\ra --- satisfy BCs on the scalar |isclr|; returns a modified |y|
			\4 |do istepc = 1, seqsize| --- loop over individual solves of flow and scalar
				\5 |icode = stepseq(istepc)| --- get sequence code
				\5 |if| this is a flow solve
					\6 |SolFlow|\ra --- perform a flow solve
				\5 |else if| this is a scalar solve
					\6 |SolSclr| --- perform a scalar solve
				\5 |else| this is an update
					\6 |itrCorrect|\ra and |itrBC|\ra --- update flow if desired
					\6 |itrCorrectSclr| and |itrBCSclr| --- update scalar if desired
			\4 |stsGetStats| --- obtain time averaged statistics
			\4 find solution at end of time step and move it to old solution variables
			\4 increment |istep| and |lstep|
			\4 |Bflux| --- compute the consistent boundary flux if desired
		\3 deallocate variables and close files
	\2 deallocate variables and close files
\end{outline}

Iteration routines...

\begin{outline}[deep]
\1 |itrPredict| --- predict solution variables at time $n+1$
	\2 |if (ipred .eq. 1)| --- we are using same-velocity prediction, as discussed in class
		\3 set $\oset{n+1}{\ul{Y}}^{(i)} = \oset{n}{\ul{Y}}$
		\3 set $\oset{n+1}{\ul{Y}}^{(i)}_{,t} = (1-1/\gamma) \oset{n}{\ul{Y}}_{,t}$
	\2 other prediction methods (zero-acceleration, same-acceleration, and same-delta) are also supported with different values of |ipred|
\end{outline}

Boundary conditions are set with the |iBC| and |BC| arrays. The bits of |iBC|, in increasing order, indicate whether the following BCs are set: $\rho$, $T$, $p$, $u_1$, $u_2$, $u_3$, scalars 1--4, periodicity, scaled plane extraction (SPEBC), axisymmetry, and deformable wall (for cardiovascular cases). This means for each global node, |iBC| has at least 14 bits. Note that |ibits(i,a,l)| extracts bits |a+1| through |a+l| of the integer |i|, and returns the base-10 integer. This routine is used to help identify and process boundary condition flags held in |iBC|.
\begin{outline}[deep]
\1 |itrBC| --- satisfy BCs on the primitive variables
	\2 impose limits on $\ul{Y}$, using the |ylimit| data structure of dimension |(3, nflow)|, whose first index contains limit flag, lower limit, and upper limit for each flow variable.
	\2 velocity BCs
		\3 
	\2 pressure BCs
		\3 
	\2 local periodic BCs
	\2 global periodic BCs
\end{outline}


\begin{center}
\begin{tabular}{@{}lll@{}}
\toprule
Symbol & Dimension & Description \\
\midrule
|nshg|   &  & \# global shape functions (|ngsh| = |nnp| if piecewise linear) \\
|nnp|    &  & \# global nodal points \\
|npro|   &  & \# elements, indexed by $e$ \\
|nshl|   &  & \# nodes per element, indexed by $a$ \\
|ndof|   &  & \# degrees of freedom, including scalars for turbulence models \\
|nflow|  &  & \# flow variables (4 incompressible, 5 compressible) \\
|ntseq|  &  & \# time sequences (?) \\
|nstep|  &  & \# time steps requested for current run \\
|lstep|  &  & current time step \\
|lstep0| &  & first time step solved by current run, initialized to |lstep+1| \\
|istep|  &  & step number relative to start of run \\
|iter|   &  & iteration number \\
|niter|  & |(MAXTS)|    & \# multi-corrector iterations per time step \\
|loctim| & |(MAXTS)|    & local time stepping flag (?) \\
|deltol| & |(MAXTS, 2)| & velocity and pressure delta ratios \\
|impl|   & |(MAXTS)|    & heat, flow, and scalar solver flags (1's, 10's and 100's places) \\
|iturb|  &  & indicates which turbulence model to use \\
|ifunc|  &  & function evaluation counter, |niter*(lstep-lstep0)+iter| \\
|ifuncs| & |(6)|						& function evaluation counter (?) \\
|y|      & |(nshg, ndof)|            & $\ul{Y}$ variables \\
|x|      & |(nshg, nsd)|             & node coordinates \\
|iBC|    & |(nshg)|                  & BC codes \\
|BC|     & |(nshg, ndofBC)|          & BC constraint parameters \\
|shp|    & |(nshape, ngauss)|        & element shape functions at Gauss points (interior) \\
|shb|    & |(nshapeb, ngaussb)|      & element shape functions at Gauss points (boundary) \\
|shgl|   & |(nsd, nshape, ngauss)|   & local shape function gradients at Gauss points (interior) \\
|shglb|  & |(nsd, nshapeb, nguassb)| & local shape function gradients at Gauss points (boundary) \\
|iper|   & |(nshg)|				    & periodicity table \\
\bottomrule
\end{tabular}
\label{tbl:symbols}
\end{center}

\section{Life's Persistent PHASTA Questions}
\begin{outline}[deep]
	\1 Is |qold|, allocated in |readnblk.f| ever deallocated? Can't find it.
	\1 Why do most of the time step parameters have dimension |MAXTS|?
		\2 It also seems that some parameters are indexed by |itseq|, but don't change from step to step.
	\1 When is it the case that $|ndof| \ne |nflow|$? For example during its limit-imposing stage, |itrbc| loops over |nflow| when indexing |y|'s dimension of size |ndof|.
\end{outline}

%%
%% DOCUMENT END
%%
\label{lastpage}
\end{document}






